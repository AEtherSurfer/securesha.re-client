<link rel="import" href="file-chooser-button.html">
<link rel="import" href="file-advanced-options.html">
<link rel="import" href="file-upload-status.html">
<link rel="import" href="file-encryptor.html">
<link rel="import" href="webworker-xhr.html">
<link rel="import" href="../bower_components/polymer-elements/polymer-ajax/polymer-ajax.html">
<polymer-element name="file-uploader" attributes="">
  <template>
    <style>
      @host { :scope {display: block;} }
    </style>
    <link rel="stylesheet" href="/styles/fileUploader.css" />

    <header>
      <h2>Upload a File</h2>
    </header>
    <article>
      <form class="form-horizontal">
        <file-chooser-button file="{{file}}"></file-chooser-button>
        <file-advanced-options closed="true" fileOptions="{{fileOptions}}"></file-advanced-options>
        <file-upload-status file="{{file}}"></file-upload-status>
      </form>
    </article>
    <file-encryptor file="{{file}}" passphrase="{{fileOptions.passphrase}}" on-encryption-finished="prepareXHR"></file-encryptor>
    <webworker-xhr id="xhrPreparer" on-xhr-prepared="uploadFile"></webworker-xhr>
  </template>
  <script>
    Polymer('file-uploader', {
      //applyAuthorStyles: true,
      //resetStyleInheritance: true,
      created: function() {
        // Create default file options
        this.fileOptions = {
          passphrase: window.secureShared.generatePassphrase(),
          days: 7,
          views: 1
        };
      },
      // We farm off XHR prep to a web worker since it can freeze up the browser for a while.
      // It's a long string.
      prepareXHR: function(e) {
        this.fire('polymer-signal', {
          name: 'upload-preparing'
        });
        this.$.xhrPreparer.prepareXHR(e.detail);
      },
      // Forgoing polymer-ajax here, it expects JSON input & attempts to querystring
      // params (in polymer-xhr). Takes too long, that's why we have the webworker
      // that just creates a qs. We'll just make an xhr ourselves.
      uploadFile: function(e) {
        var xhr = new XMLHttpRequest();
        
        // Attach handlers
        xhr.onload = this.handleResponse.bind(this, xhr);
        xhr.onerror = this.handleError.bind(this, xhr);
        // Attach progress handler, if possible
        if (xhr.upload) {
          xhr.upload.addEventListener('progress', this.handleUploadProgress.bind(this), false);
        }

        // Create xhr data
        var params = e.detail;
        var url = '/putfile';
        var method = 'POST';
        var async = true;

        // Open xhr
        xhr.open(method, url, async);

        // Set headers
        xhr.setRequestHeader('Content-Type', 'application/octet-stream');
        xhr.setRequestHeader('X-File-Expiration-Days', this.fileOptions.days);
        xhr.setRequestHeader('X-File-Name', params.fileName);
        xhr.setRequestHeader('X-File-Max-Views', this.fileOptions.views);
        xhr.setRequestHeader('X-File-Content-Type', params.contentType);

        // We're only sending the actual file data up the pipe as a binary stream.
        xhr.send(params.fileData);
      },
      handleResponse: function(xhr, event) {
        var response;
        try {
          response = JSON.parse(xhr.responseText);
        } catch(e) {
          return console.error("Unable to parse server response.");
        }
        this.fire('polymer-signal', {
          name: 'upload-complete', 
          data: {
            fileName: response.url,
            passphrase: this.fileOptions.passphrase
          }
        });
      },
      handleError: function(xhr, event) {
        console.error("Error when uploading file:", event);
      },
      // Fire a signal whenever we get a progress report
      handleUploadProgress: function(e) {
        if (!e.lengthComputable) return;        
        this.fire('polymer-signal', {
          name: 'upload-progress',
          data: {
            value: e.loaded,
            max: e.total
          }
        });
      },
      enteredView: function() { },
      leftView: function() { },
      attributeChanged: function(attrName, oldVal, newVal) { }
    });
  </script>
</polymer-element>