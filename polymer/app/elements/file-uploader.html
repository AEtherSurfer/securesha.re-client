<link rel="import" href="file-chooser-button.html">
<link rel="import" href="file-advanced-options.html">
<link rel="import" href="file-upload-status.html">
<link rel="import" href="file-encryptor.html">
<link rel="import" href="webworker-xhr.html">
<link rel="import" href="../bower_components/polymer-elements/polymer-ajax/polymer-ajax.html">
<polymer-element name="file-uploader" attributes="">
  <template>
    <style>
      @host { :scope {display: block;} }
    </style>
    <link rel="stylesheet" href="/styles/fileUploader.css" />

    <header>
      <h2>Upload a File</h2>
    </header>
    <article>
      <form class="form-horizontal" enctype="multipart/form-data">
        <file-chooser-button file="{{file}}"></file-chooser-button>
        <file-encryptor file="{{file}}" passphrase="{{fileOptions.passphrase}}" on-encryption-finished="prepareXHR"></file-encryptor>
        <webworker-xhr id="xhrPreparer" on-xhr-prepared="uploadFile"></webworker-xhr>
        <file-advanced-options closed="true" fileOptions="{{fileOptions}}"></file-advanced-options>
        <file-upload-status></file-upload-status>
        <ajax-raw id="ajaxUploader" url="/putfile" method="POST"
            params="{{ajaxParams}}"
            handleAs="json"
            on-polymer-response="handleResponse">
        </polymer-ajax>
      </form>
    </article>
  </template>
  <script>
    Polymer('file-uploader', {
      //applyAuthorStyles: true,
      //resetStyleInheritance: true,
      created: function() {
        // Create default file options
        this.fileOptions = {
          passphrase: window.secureShared.generatePassphrase(),
          days: 7,
          views: 1
        };
      },
      prepareXHR: function(e) {
        this.$.xhrPreparer.prepareXHR(e.detail);
      },
      // Forgoing polymer-ajax here, it expects JSON input & attempts to querystring
      // params (in polymer-xhr). Takes too long, that's why we have the webworker
      // that just creates a qs. We'll just make an xhr ourselves.
      uploadFile: function(e) {
        var xhr = new XMLHttpRequest();
        // Attach progress handler, if possible
        if (xhr.upload) {
          xhr.upload.addEventListener('progress', this.handleUploadProgress.bind(this), false);
        }

        // Create xhr data
        var params = e.detail;
        var url = '/putfile';
        var method = 'POST';
        var async = true;

        // Open xhr
        xhr.open(method, url, async);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            this.handleResponse(xhr.response, xhr);
          }
        }.bind(this);
        xhr.send(params);
      },
      handleResponse: function(response, xhr) {
        try {
          response = JSON.parse(response);
        } catch(e) {
          console.error("Unable to parse server response.");
        }
        console.dir(response);
      },
      // Fire a signal whenever we get a progress report
      handleUploadProgress: function(e) {
        if (!e.lengthComputable) return;        
        this.fire('polymer-signal', {
          name: 'upload-progress',
          data: {
            value: e.loaded,
            max: e.total
          }
        });
      },
      enteredView: function() { },
      leftView: function() { },
      attributeChanged: function(attrName, oldVal, newVal) { }
    });
  </script>
</polymer-element>